<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ุชุตููู ุงูุฃููู</title>
  <link rel="stylesheet" href="../../CSS/style.css" />
  <script src="../../navbar.js" defer></script>
  <link rel="icon" href="https://abdo12249.github.io/1/navbar/favicon.ico" type="image/x-icon" />
</head>
<body>
  <div id="navbar-container"></div>

  <main>
    <div class="section-header">
      <h1 id="category-title">ุงูุชุตููู</h1>
    </div>

    <div class="anime-grid" id="animeGrid"></div>

    <!-- ุงูุชุฑููู -->
    <div class="pagination" id="pagination" style="text-align:center; margin: 20px;"></div>
  </main>

  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="spinner"></div>
    <span>ุฌุงุฑู ุชุญููู ุงูุฃููู...</span>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const category = urlParams.get('category') || '';
    let currentPage = parseInt(urlParams.get('page') || '1'); // ุฌุนููุง let ูุชุญุฏูุซูุง
    const animesPerPage = 24;

    document.getElementById("category-title").textContent = category
      ? "ุชุตููู: " + category
      : "ุฌููุน ุงูุฃูููุงุช";

    let allAnimes = []; // ุณูุชู ุชุฎุฒูู ุฌููุน ุงูุฃูููุงุช ุจุนุฏ ุงูููุชุฑุฉ ููุง ููุนุฑุถ
    let originalAnimesFromSource = []; // ุณูุชู ุชุฎุฒูู ุฌููุน ุงูุฃูููุงุช ุงูุชู ุชู ุฌูุจูุง ูู ุงููุตุฏุฑ (ุงูุดุจูุฉ ุฃู ุงููุงุด)

    const cacheDuration = 24 * 60 * 60 * 1000; // 24 ุณุงุนุฉ ุจุงููููู ุซุงููุฉ

    const DB_NAME = 'AnimeCategoriesDB'; // ุงุณู ูุงุนุฏุฉ ุจูุงูุงุช ูุฎุชููุฉ ูุชุฌูุจ ุงูุชุนุงุฑุถ
    const DB_VERSION = 1;
    const STORE_NAME = 'animeDataCache';
    const CACHE_KEY = 'cachedAnimeCategories';

    let db; // ูุชุบูุฑ ููุงุญุชูุงุธ ุจูุณุฎุฉ ูุงุนุฏุฉ ุจูุงูุงุช IndexedDB

    // ุฏุงูุฉ ููุชุญ ูุงุนุฏุฉ ุจูุงูุงุช IndexedDB
    function openDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = (event) => {
          db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME);
          }
        };
        request.onsuccess = (event) => {
          db = event.target.result;
          resolve(db);
        };
        request.onerror = (event) => {
          console.error("โ ุฎุทุฃ ูู ูุชุญ IndexedDB:", event.target.error);
          reject(event.target.error);
        };
      });
    }

    // ุฏุงูุฉ ููุฑุงุกุฉ ุงูุจูุงูุงุช ูู IndexedDB
    async function readFromIndexedDB(key) {
      if (!db) await openDatabase();
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(key);
        request.onsuccess = (event) => resolve(event.target.result);
        request.onerror = (event) => reject(event.target.error);
      });
    }

    // ุฏุงูุฉ ููุชุงุจุฉ ุงูุจูุงูุงุช ุฅูู IndexedDB
    async function writeToIndexedDB(key, data) {
      if (!db) await openDatabase();
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.put(data, key);
        request.onsuccess = () => resolve();
        request.onerror = (event) => reject(event.target.error);
      });
    }

    // ุฏุงูุฉ ูุฅุธูุงุฑ ุดุงุดุฉ ุงูุชุญููู
    function showLoading() {
      document.getElementById('loadingOverlay').style.display = 'flex';
    }

    // ุฏุงูุฉ ูุฅุฎูุงุก ุดุงุดุฉ ุงูุชุญููู
    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    // ุฏุงูุฉ ูุชุนุฏูู ูุณุงุฑ ุงูุตูุฑุฉ
    function adjustPath(path) {
      // ูุฐู ุงูุฏุงูุฉ ุชุนุฏู ุงููุณุงุฑ ููุชูุงุณุจ ูุน ูููู ุงููุฌูุฏุงุช ุงูุฎุงุต ุจู.
      // ุฅุฐุง ูุงูุช ุตูุฑู ูู ููุณ ุงููุฌูุฏ ุฃู ูุณุงุฑ ูุณุจู ูุฎุชููุ ููุฏ ุชุญุชุงุฌ ุฅูู ุชุนุฏูู ูุฐุง.
      return path.startsWith('../') ? path.replace('../', '../../') : path;
    }

    // ุฏุงูุฉ ูููุชุฑุฉ ุงูุฃููู ุจูุงุกู ุนูู ุงูุชุตููู ุงููุญุฏุฏ ูู URL
    function filterAnime(animeList) {
      if (!category) {
        return animeList; // ุฅุฐุง ูู ููู ููุงู ุชุตููู ูุญุฏุฏุ ุนุฑุถ ุงููู
      }
      return animeList.filter(anime => {
        const tags = anime.tags || anime.categories || [];
        const type = anime.type || '';
        const status = anime.status || '';
        const season = anime.season || '';
        // ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงูุชุตููู ุงููุญุฏุฏ ููุฌูุฏูุง ูู ุฃู ูู ุงูุญููู ุฐุงุช ุงูุตูุฉ
        return tags.includes(category) || type === category || status === category || season === category;
      });
    }

    // ุฏุงูุฉ ูุนุฑุถ ุตูุญุฉ ูุนููุฉ ูู ุงูุฃูููุงุช ุงููููุชุฑุฉ
    function displayPage(animeList) {
      const start = (currentPage - 1) * animesPerPage;
      const end = start + animesPerPage;
      const animeGrid = document.getElementById("animeGrid");
      animeGrid.innerHTML = ""; // ูุณุญ ุงููุญุชูู ุงูุญุงูู

      animeList.slice(start, end).forEach(anime => {
        const tags = anime.tags || anime.categories || [];
        const link = `../../test1/Anime Page Dynamic.html?id=${anime.id}`;
        const card = document.createElement("div");
        card.className = "anime-card";

        card.innerHTML = `
          <a href="${link}" style="text-decoration: none; color: inherit;">
            <div class="anime-image">
              <img src="${adjustPath(anime.image)}" alt="${anime.title}" loading="lazy" />
            </div>
            <div class="anime-info">
              <h3>${anime.title}</h3>
              <p>${anime.description || ''}</p>
              <div class="anime-meta">
                <span><strong>ุงูููุน:</strong> ${anime.type || ''}</span>
                <span><strong>ุงูุชุตูููุงุช:</strong> ${tags.join(', ')}</span>
                <span><strong>ุงูููุณู:</strong> ${anime.season || 'ุบูุฑ ูุชููุฑ'}</span>
                <span><strong>ุงูุญุงูุฉ:</strong> ${anime.status || 'ุบูุฑ ูุนุฑูู'}</span>
                <span class="watch-button">ุดุงูุฏ ุงูุขู</span>
              </div>
            </div>
          </a>
        `;

        animeGrid.appendChild(card);
      });

      // ุฅุถุงูุฉ ูุฑุงูุจ ููุชุญููู ุงูุชุฏุฑูุฌู ููุตูุฑ ุจุนุฏ ุนุฑุถ ุงูุตูุญุฉ
      const lazyImages = document.querySelectorAll('#animeGrid img[loading="lazy"]');
      if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              img.classList.add('loaded');
              observer.unobserve(img);
            }
          });
        });
        lazyImages.forEach(img => observer.observe(img));
      } else {
        lazyImages.forEach(img => img.classList.add('loaded'));
      }
    }

    // ุฏุงูุฉ ูุฅูุดุงุก ุฃุฒุฑุงุฑ ุงูุชุฑููู (Pagination)
    function createPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / animesPerPage);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      for (let i = 1; i <= totalPages; i++) {
        const button = document.createElement("button");
        button.textContent = i;
        button.style.margin = "0 4px";
        button.style.padding = "5px 10px";
        button.style.background = (i === currentPage) ? "#ef4444" : "#333";
        button.style.color = "#fff";
        button.style.border = "none";
        button.style.cursor = "pointer";
        button.style.borderRadius = "6px"; // ุฅุถุงูุฉ ุญุฏูุฏ ูุณุชุฏูุฑุฉ

        button.onclick = () => {
          const newUrl = new URL(window.location.href);
          newUrl.searchParams.set("page", i);
          if (category) newUrl.searchParams.set("category", category);
          window.location.href = newUrl.toString(); // ุฅุนุงุฏุฉ ุชูุฌูู ูุชุญุฏูุซ URL ูุงูุตูุญุฉ
        };

        pagination.appendChild(button);
      }
    }

    // ุฏุงูุฉ ุฑุฆูุณูุฉ ูุชุญููู ุงูุฃูููุงุช ูุชุทุจูู ุงูุชุญุฏูุซ ุงูุชููุงุฆู
    async function loadAnimes() {
      showLoading(); // ุฅุธูุงุฑ ุดุงุดุฉ ุงูุชุญููู

      await openDatabase(); // ุงูุชุฃูุฏ ูู ูุชุญ IndexedDB

      let cachedAnimesData = null;
      let networkAnimesData = null;
      let renderedFromCache = false; // ุนูุงูุฉ ููุชุญูู ููุง ุฅุฐุง ูุงู ุงูุนุฑุถ ุงูุฃููู ูุฏ ุชู ูู ุงููุงุด

      // 1. ูุญุงููุฉ ุงูุชุญููู ูู IndexedDB ุฃููุงู ููุนุฑุถ ุงูุณุฑูุน
      try {
        const cachedObject = await readFromIndexedDB(CACHE_KEY);
        const now = Date.now();
        if (cachedObject && cachedObject.animes && (now - cachedObject.timestamp) < cacheDuration) {
          cachedAnimesData = cachedObject.animes;
          originalAnimesFromSource = [...cachedAnimesData]; // ุชุนููู ุงูุจูุงูุงุช ุงูุฃุตููุฉ ูู ุงููุงุด
          allAnimes = filterAnime(originalAnimesFromSource); // ููุชุฑุฉ ูุนุฑุถ ูู ุงููุงุด
          displayPage(allAnimes);
          createPagination(allAnimes.length);
          renderedFromCache = true;
          console.log("โ ุชู ุชุญููู ุจูุงูุงุช ุงูุฃููู ูู IndexedDB.");
        } else {
          console.log("๐ ูุง ุชูุฌุฏ ุจูุงูุงุช ุตุงูุญุฉ ูู IndexedDB ุฃู ุงูุชูุช ุตูุงุญูุชูุง. ุณูุชู ุฌูุจ ุจูุงูุงุช ุฌุฏูุฏุฉ.");
        }
      } catch (error) {
        console.error("โ ุฎุทุฃ ูู ูุฑุงุกุฉ IndexedDB ุฃุซูุงุก ุงูุชุญููู ุงูุฃููู:", error);
      }

      // 2. ุฏุงุฆููุง ุญุงูู ุฌูุจ ุงูุจูุงูุงุช ูู ุงูุดุจูุฉ
      try {
        console.log("๐ ุฌูุจ ุจูุงูุงุช ุงูุฃููู ูู ุงูุดุจูุฉ...");
        const response = await fetch("https://abdo12249.github.io/1/test1/animes.json");
        if (!response.ok) throw new Error("โ ูุดู ุชุญููู animes.json ูู ุงูุดุจูุฉ");

        const data = await response.json();
        networkAnimesData = Object.entries(data).map(([id, anime]) => ({ id, ...anime }));

        // ูุฑุฒ ุงูุจูุงูุงุช ูุถูุงู ููุงุฑูุฉ ูุชุณูุฉ
        networkAnimesData.sort((a, b) => a.id.localeCompare(b.id));

        // ุงูุญุตูู ุนูู ุงูุจูุงูุงุช ุงูุญุงููุฉ ููููุงุฑูุฉ (ุณูุงุก ูู ุงููุงุด ุฃู ูุงุฑุบุฉ ุฅุฐุง ูู ููู ููุงู ูุงุด ุตุงูุญ)
        let currentDataForComparison = cachedAnimesData ? [...cachedAnimesData] : [];
        currentDataForComparison.sort((a, b) => a.id.localeCompare(b.id));

        // ููุงุฑูุฉ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ูู ุงูุดุจูุฉ ูุน ุงูุจูุงูุงุช ุงูุญุงููุฉ
        if (JSON.stringify(networkAnimesData) !== JSON.stringify(currentDataForComparison)) {
          console.log("โ ุชู ุงูุชุดุงู ุชุบููุฑุงุช ูู ุงูุจูุงูุงุช. ุชุญุฏูุซ IndexedDB ูุงููุงุฌูุฉ.");
          const cacheObject = {
            animes: networkAnimesData,
            timestamp: Date.now()
          };
          await writeToIndexedDB(CACHE_KEY, cacheObject);

          // ุชุญุฏูุซ ุงููุชุบูุฑุงุช ุงูุนุงูููุฉ ุจุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ
          originalAnimesFromSource = [...networkAnimesData];
          allAnimes = filterAnime(originalAnimesFromSource); // ุฅุนุงุฏุฉ ููุชุฑุฉ ูุนุฑุถ ุจุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ

          // ุฅุนุงุฏุฉ ุนุฑุถ ุงููุงุฌูุฉ ุจุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ
          displayPage(allAnimes);
          createPagination(allAnimes.length);
        } else {
          console.log("โ ุงูุจูุงูุงุช ูู ุงูุดุจูุฉ ูุทุงุจูุฉ ููุจูุงูุงุช ุงููุฎุฒูุฉ ูุคูุชูุง. ูุง ุญุงุฌุฉ ููุชุญุฏูุซ.");
          // ุฅุฐุง ูู ูุชู ุงูุนุฑุถ ูู ุงููุงุด ูู ุงูุจุฏุงูุฉ ูููู ุงูุจูุงูุงุช ูุทุงุจูุฉุ ูุฌุจ ุฃู ูุนุฑุถูุง ุงูุขู
          // (ูุฐุง ูุบุทู ุญุงูุฉ ุฃูู ุชุญููู ุญูุซ ูุง ููุฌุฏ ูุงุด ุฃู ุงูุชูุช ุตูุงุญูุชู ูููู ุงูุดุจูุฉ ุฃุนุงุฏุช ููุณ ุงูุจูุงูุงุช)
          if (!renderedFromCache && allAnimes.length === 0 && originalAnimesFromSource.length === 0) {
              originalAnimesFromSource = [...networkAnimesData];
              allAnimes = filterAnime(originalAnimesFromSource);
              displayPage(allAnimes);
              createPagination(allAnimes.length);
          }
        }

      } catch (networkError) {
        console.error("โ ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช ูู ุงูุดุจูุฉ:", networkError);
        // ุฅุฐุง ูุดู ุฌูุจ ุงูุดุจูุฉ ููู ูุชู ุงูุนุฑุถ ูู ุงููุงุด ูู ุงูุจุฏุงูุฉุ ุญุงูู ุงูุชุญููู ูู ุงููุงุด ูุฎูุงุฑ ุงุญุชูุงุทู (ุญุชู ูู ุงูุชูุช ุงูุตูุงุญูุฉ)
        if (!renderedFromCache) {
          try {
            const cachedObject = await readFromIndexedDB(CACHE_KEY);
            if (cachedObject && cachedObject.animes) {
              originalAnimesFromSource = [...cachedObject.animes];
              allAnimes = filterAnime(originalAnimesFromSource);
              displayPage(allAnimes);
              createPagination(allAnimes.length);
              console.log("โ๏ธ ุชู ุชุญููู ุจูุงูุงุช ุงูุฃููู ูู IndexedDB ูุฎูุงุฑ ุงุญุชูุงุทู ุจุณุจุจ ูุดู ุงูุดุจูุฉ.");
            } else {
              console.error("โ ูุง ุชูุฌุฏ ุจูุงูุงุช ูู IndexedDB. ูุง ูููู ุนุฑุถ ุฃู ุฃูููุงุช.");
              // ููููู ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ูููุณุชุฎุฏู ููุง
            }
          } catch (dbFallbackError) {
            console.error("โ ุฎุทุฃ ูู ูุฑุงุกุฉ IndexedDB ูุฎูุงุฑ ุงุญุชูุงุทู:", dbFallbackError);
          }
        }
      } finally {
        hideLoading(); // ุฅุฎูุงุก ุดุงุดุฉ ุงูุชุญููู
      }
    }

    // ุจุฏุก ุงูุชููุฆุฉ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
    loadAnimes();
  </script>

  <script>
    // ุชุญููู ุดุฑูุท ุงูุชููู (navbar)
    fetch('../../navbar.html')
      .then(response => response.text())
      .then(data => document.getElementById('navbar-container').innerHTML = data)
      .catch(error => console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุดุฑูุท ุงูุนููู:', error));
  </script>
</body>
</html>
